---
import Layout from "../../layouts/Layout.astro";
import PlotFigure from "../../components/PlotFigure.astro";
import penguins from "../../assets/penguins.json";
import * as Plot from "@observablehq/plot";

// IMPORTANT : Désactiver le pré-rendu pour les routes dynamiques
export const prerender = false;

// Récupérer le paramètre d'URL
const { species } = Astro.params;

// Filtrer les pingouins pour l'espèce spécifiée
const filteredPenguins = penguins.filter((p) => p.species === species);

// Configuration du graphique
const plotOptions = {
  title: `Analyse de l'espèce ${species}`,
  grid: true,
  marks: [
    Plot.dot(filteredPenguins, {
      x: "culmen_length_mm",
      y: "culmen_depth_mm",
      fill: "sex",
      stroke: "white",
      r: 5,
      fillOpacity: 0.8,
    }),
  ],
  x: {
    label: "Longueur du bec (mm)",
  },
  y: {
    label: "Profondeur du bec (mm)",
  },
  // Pas de légende pour éviter les erreurs SSR
};
---

<Layout>
  <div class="container mx-auto px-4">
    <!-- Breadcrumb -->
    <div class="breadcrumbs text-sm mb-6">
      <ul>
        <li><a href="/" class="link link-hover">🏠 Accueil</a></li>
        <li><a href="/rendu-dynamique" class="link link-hover">Routes Dynamiques</a></li>
        <li>{species}</li>
      </ul>
    </div>

    <!-- Hero -->
    <div class="hero bg-gradient-to-r from-blue-400 to-indigo-600 text-white rounded-lg mb-8">
      <div class="hero-content">
        <div class="text-center">
          <h1 class="text-4xl font-bold">🐧 {species}</h1>
          <p class="py-4">{filteredPenguins.length} individus analysés</p>
          <div class="badge badge-primary">🔄 Route Dynamique</div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats stats-vertical lg:stats-horizontal shadow mb-8 w-full">
      <div class="stat">
        <div class="stat-figure text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <div class="stat-title">Mâles</div>
        <div class="stat-value text-primary">{filteredPenguins.filter((p) => p.sex === "MALE").length}</div>
      </div>
      
      <div class="stat">
        <div class="stat-figure text-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
          </svg>
        </div>
        <div class="stat-title">Femelles</div>
        <div class="stat-value text-secondary">{filteredPenguins.filter((p) => p.sex === "FEMALE").length}</div>
      </div>

      <div class="stat">
        <div class="stat-figure text-accent">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
          </svg>
        </div>
        <div class="stat-title">Total</div>
        <div class="stat-value text-accent">{filteredPenguins.length}</div>
      </div>
    </div>

    <!-- Chart Card -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">📊 Analyse Graphique</h2>
        <PlotFigure options={plotOptions} />
      </div>
    </div>
  </div>
</Layout>
